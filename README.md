# mercury200-multi

**Пакетный опрос счётчиков «Меркурий-200» через RS-485 ↔ Ethernet-шлюзы  
USR-IOT TCP232-304, заведённые за один IP-адрес (HAProxy).**

> Скрипт: **`mercury200_multipoll.py`** (Python ≥ 3.7)  
> Зависимостей **нет** — используется только стандартная библиотека.

---

## Содержание

| Раздел | Описание |
|--------|----------|
| [Возможности](#возможности) | Что умеет (и чего не делает) скрипт. |
| [Топология](#топология) | Наглядная схема подключения. |
| [Быстрый старт](#быстрый-старт) | Запуск за минуту. |
| [Конфигурация](#конфигурация) | IP, порты, серийные номера, тайм-ауты. |
| [Пример вывода](#пример-вывода) | Итоговая таблица. |
| [Структура проекта](#структура-проекта) | Что лежит в репозитории. |
| [Замечания по безопасности](#замечания-по-безопасности) | Почему чтение безопасно. |
| [Лицензия](#лицензия) | MIT — берите и пользуйтесь. |

---

## Возможности

* **Один файл, без сторонних библиотек** — нужен только Python ≥ 3.7.
* Работает в режиме **RTU-over-TCP** (шлюз прозрачно дает доступ).
* Поддерживает **несколько портов** HAProxy, за каждым — свой TCP232-304.
* Читает лишь «открытые» команды:  
  * `63h` — напряжение **U**, ток **I**, мощность **P** (Вт)  
  * `27h` — энергия **T1**, **T2** (кВт·ч)
* План опроса задаётся либо **в коде**, либо во внешнем **`serials.txt`**.
* Красивое форматирование таблицы, онлайн-диагностика CRC/тайм-аутов.

> ⚠️ Скрипт **ничего не пишет** в счётчик, только читает.

## Быстрый старт<a name="быстрый-старт"></a>

```bash
# 1. Клонируем / скачиваем
git clone https://github.com/USERNAME/mercury200-multi.git
cd mercury200-multi

# 2. (опц.) виртуальное окружение
python3 -m venv venv && . venv/bin/activate

# 3. Правим IP/порты/серийники или создаём serials.txt
nano mercury200_multipoll.py

# 4. Запускаем
python3 mercury200_multi.py
```

Конфигурация<a name="конфигурация"></a>
Вариант А — изменить переменные в коде
```
IP_HAPROXY = '192.168.1.100'

POLL_MAP = {                      # порт : [серийники (6 цифр)]
    10000: ['567892', '567893'],
    10001: ['590001'],
}
```
Вариант Б — файл serials.txt
```
порт  серийный  [серийный …]   (разделитель — пробел/таб)
10000 567892 567893
10001 590001
```
Файл лежит рядом со скриптом и перекрывает POLL_MAP.

# Дополнительные параметры
* TIMEOUT	ожидание ответа, сек	0.8
* RETRY	попыток при тайм-ауте	1

Пример вывода<a name="пример-вывода"></a>
```
Port |Serial  |   U,В|   I,А|  P,Вт|   T1,кВт·ч|   T2,кВт·ч
--------------------------------------------------------------
10000|567892  | 228.4|  1.23|    272|    5138.84|    1937.32
10000|567893  | 229.1|  0.97|    221|    4875.60|    1850.47
10001|590001  | 228.7|  1.05|    240|    5010.12|    1920.00
--------------------------------------------------------------
При ошибке связи строка остаётся, поля помечаются «нет ответа/CRC».
```

## Структура проекта<a name="структура-проекта"></a>
* mercury200_multipoll.py	основной скрипт
* serials.txt (опц.)	карта «порт → серийники»
* README.md	документация

## Замечания по безопасности<a name="замечания-по-безопасности"></a>
Используются только читающие команды (63h, 27h) — параметры счётчика не изменяются.

Если HAProxy доступен из интернета, ограничьте доступ к портам фаерволом или VPN,
иначе любой сможет видеть ваши показания.

## Лицензия<a name="лицензия"></a>
MIT — свободно используйте, модифицируйте и распространяйте.
Если скрипт оказался полезен, поставьте ⭐ в репозитории!
